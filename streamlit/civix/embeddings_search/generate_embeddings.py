import os

import openai  # for calling the OpenAI API
import pandas as pd  # for storing text and embeddings data


EMBEDDING_MODEL = "text-embedding-ada-002"  # OpenAI's best embeddings as of Apr 2023
BATCH_SIZE = 1000  # you can submit up to 2048 embedding inputs per request

def main():
    pass
    generate_statute_name_embeddings()


def generate_statute_name_embeddings():
    statutes = get_statutes()
    generate_embeddings(statutes, get_statute_name_path())


def generate_embeddings(string_list, filename):
    embeddings = []
    for batch_start in range(0, len(string_list), BATCH_SIZE):
        batch_end = batch_start + BATCH_SIZE
        batch = string_list[batch_start:batch_end]
        print(f"Batch {batch_start} to {batch_end-1}")
        response = openai.Embedding.create(model=EMBEDDING_MODEL, input=batch)
        for i, be in enumerate(response["data"]):
            assert i == be["index"]  # double check embeddings are in same order as input
        batch_embeddings = [e["embedding"] for e in response["data"]]
        embeddings.extend(batch_embeddings)
    
    df = pd.DataFrame({"text": string_list, "embedding": embeddings})
    
    save_path = f"data/{filename}"
    
    # Create the directory if it doesn't exist
    os.makedirs(os.path.dirname(save_path), exist_ok=True)
    
    # Write DataFrame to the file
    df.to_csv(save_path, index=False)



def get_statute_name_path():
    SAVE_PATH = "statute_name_embeddings.csv"
    return SAVE_PATH


def get_statutes():
    statutes = list(set(['Access to Abortion Services Act', 'Access to Services (COVID-19) Act', 'Accessible British Columbia Act', 'Administrative Tribunals Act', 'Adoption Act', 'Adult Guardianship Act', 'Advanced Education Statute Repeal Act', 'Age of Majority Act', 'Agricultural Land Commission Act', 'Agricultural Land Commission Act', 'Anatomy Act', 'Animal Health Act', 'Anti-Racism Data Act', 'Apology Act', 'Arbitration Act', 'Architects (Landscape) Act', 'Armoured Vehicle and After-Market Compartment Control Act', 'Arts Council Act', 'Assessment Act', 'Assessment Authority Act', 'Assistance to Shelter Act', 'Athletic Commissioner Act', 'Attorney General Act', 'Auditor General Act', 'Balanced Budget and Ministerial Accountability Act', 'BC-Alcan Northern Development Fund Act', 'BC Benefits (Child Care) Act', 'BC Benefits (Child Care Subsidy) Act', 'BC Hydro Public Power Legacy and Heritage Contract Act', 'BC Online Act', 'B.C. Pavilion Corporation Act', 'B.C. Rail Benefits (First Nations) Trust Act', 'BC Transportation Financing Authority Transit Assets and Liabilities Act', 'Body Armour Control Act', 'Bonding Act', 'Boundary Act', 'British Columbia Day Act', 'British Columbia Innovation Council Act', 'British Columbia Neurotrauma Fund Contribution Act', 'British Columbia Railway Act', 'British Columbia Railway Finance Act', 'British Columbia Transit Act', 'Budget Measures Implementation Act, 1996', 'Budget Measures Implementation Act, 2000', 'Budget Measures Implementation (Employer Health Tax) Act, 2018', 'Budget Measures Implementation (Speculation and Vacancy Tax) Act, 2018', 'Budget Transparency and Accountability Act', 'Builders Lien Act', 'Building Act', "Building Officials' Association Act", 'Business Corporations Act', 'Business Number Act', 'Business Practices and Consumer Protection Act', 'Business Practices and Consumer Protection Authority Act', 'Credit Union Incorporation Act', 'Creditor Assistance Act', 'Cremation, Interment and Funeral Services Act', 'Creston Valley Wildlife Act', 'Crime Victim Assistance Act', 'Criminal Asset Management Act', 'Criminal Code', 'Criminal Injury Compensation Act', 'Criminal Records Review Act', 'Crown Counsel Act', 'Crown Franchise Act', 'Crown Proceeding Act', 'Charitable Purposes Preservation Act', 'Chartered Professional Accountants Act', 'Child Care BC Act', 'Child Care Subsidy Act', 'Child, Family and Community Service Act', 'Civil Forfeiture Act', 'Civil Resolution Tribunal Act', 'Civil Resolution Tribunal Amendment Act, 2018', 'Civil Rights Protection Act', 'Class Proceedings Act', 'Clean Energy Act', 'Climate Change Accountability Act', 'Coal Act', 'Coalbed Gas Act', 'Coastal Ferry Act', 'College and Institute Act', 'Columbia Basin Trust Act', 'Commercial Arbitration Act', 'Commercial Liens Act', 'Commercial Tenancy Act', 'Commercial Transport Act', 'Community Care and Assisted Living Act', 'Community Charter', 'Community Charter Transitional Provisions, Consequential Amendments and Other Amendments Act', 'Community Living Authority Act', 'Community Safety Act', 'Community Services Interim Authorities Act', 'Community Services Labour Relations Act', 'Conflict of Laws Rules for Trusts Act', 'Constitution Act', 'Constitutional Amendment Approval Act', 'Constitutional Question Act', 'Container Trucking Act', 'Continuing Care Act', 'Cooperative Association Act', 'Coroners Act', 'Correction Act', 'County Boundary Act', 'Court Agent Act', 'Court Jurisdiction and Proceedings Transfer Act', 'Court of Appeal Act', 'Court Order Enforcement Act', 'Court Order Interest Act', 'Court Rules Act', 'Canadian Pacific Railway (Stone and Timber) Settlement Act', 'Cannabis Control and Licensing Act', 'Cannabis Distribution Act', 'Carbon Tax Act', 'Debtor Assistance Act', 'Declaration on the Rights of Indigenous Peoples Act', 'Degree Authorization Act', 'Destination BC Corp. Act', 'Dike Maintenance Act', 'Disciplinary Authority Protection Act', 'Douglas Day Act', 'Drainage, Ditch and Dike Act', 'Drinking Water Protection Act', 'Early Childhood Educators Act', 'Early Learning and Child Care Act', 'Ecological Reserve Act', 'Economic Incentive and Stabilization Statutes Amendment Act, 2008', 'Economic Stabilization (COVID-19) Act', 'E-Health (Personal Health Information Access and Protection of Privacy) Act', 'Election Act', 'Electoral Boundaries Commission Act', 'Electoral Districts Act', 'Electoral Reform Referendum 2018 Act', 'Electronic Transactions Act', 'Emergency and Health Services Act', 'Emergency Communications Corporations Act', 'Emergency Health Services Act', 'Emergency Intervention Disclosure Act', 'Emergency Program Act', 'Employee Investment Act', 'Employer Health Tax Act', 'Employment and Assistance Act', 'Employment and Assistance for Persons with Disabilities Act', 'Employment Standards Act', 'Energy Efficiency Act', 'Enforcement of Canadian Judgments and Decrees Act', 'Environment and Land Use Act', 'Environmental Assessment Act', 'Environmental Management Act', 'Escheat Act', 'Estates of Missing Persons Act', 'Evidence Act', 'Expropriation Act', 'Expropriation Amendment Act, 2004', 'Financial Services Authority Act', 'Financial Services Authority Act, 2019', 'Fire and Police Services Collective Bargaining Act', 'Fire Department Act', 'Fire Safety Act', 'Fire Services Act', 'Firearm Act', 'Firearm Violence Prevention Act', 'Fireworks Act', 'First Nations Education Act', "First Peoples' Heritage, Language and Culture Act", 'Fish and Seafood Act', 'Fish Protection Act', 'Fishing Collective Bargaining Act', 'Flathead Watershed Area Conservation Act', 'Flood Relief Act', 'FNCIDA Implementation Act', 'Food and Agricultural Products Classification Act', 'Food Delivery Service Fee Act', 'Food Donor Encouragement Act', 'Food Safety Act', 'Foreign Arbitral Awards Act', 'Foreign Money Claims Act', 'Forensic Psychiatry Act', 'Forest Act', 'Forest and Range Practices Act', 'Forest Practices Code of British Columbia Act', 'Forest Stand Management Fund Act', 'Forestry Revitalization Act', 'Forestry Service Providers Protection Act', 'Franchises Act', 'Fraudulent Conveyance Act', 'Fraudulent Preference Act', 'Freedom of Information and Protection of Privacy Act', 'Frustrated Contract Act', 'Fuel Price Transparency Act', 'Family Compensation Act', 'Family Day Act', 'Family Law Act', 'Family Maintenance Enforcement Act', 'Farm Income Insurance Act', 'Farm Practices Protection (Right to Farm) Act', 'Farmers and Womens Institutes Act', 'Farming and Fishing Industries Development Act', 'Federal Courts Jurisdiction Act', 'Federal Port Development Act', 'Finance Statutes Amendment Act, 2011', 'Financial Administration Act', 'Financial Disclosure Act', 'Financial Information Act', 'Financial Institutions Act', 'Gaming Control Act', 'Gaming Control Act', 'Gas Utility Act', 'Geothermal Resources Act', 'Good Samaritan Act', 'Government Buildings Act', 'Great Bear Rainforest (Forest Management) Act', 'Greater Vancouver Sewerage and Drainage District Act', 'Greater Vancouver Transportation Authority Act', 'Greater Vancouver Water District Act', 'Greenbelt Act', 'Greenhouse Gas Industrial Reporting and Control Act', 'Greenhouse Gas Reduction (Renewable and Low Carbon Fuel Requirements) Act', 'Greenhouse Gas Reduction Targets Act', 'Greenhouse Gas Reduction (Vehicle Emissions Standards) Act', 'Guide Dog and Service Dog Act', 'Gunshot and Stab Wound Disclosure Act', 'Health Care (Consent) and Care Facility (Admission) Act', 'Health Care Costs Recovery Act', 'Health Emergency Act', 'Health Professions Act', 'Health Professions and Occupations Act', 'Health Special Account Act', 'Heritage Conservation Act', 'Highway (Industrial) Act', 'Holocaust Memorial Day Act', 'Home Owner Grant Act', 'Homeowner Protection Act', 'Hospital Act', 'Hospital District Act', 'Hospital Insurance Act', 'Hotel Guest Registration Act', 'Hotel Keepers Act', 'Housing Supply Act', 'Human Resource Facility Act', 'Human Rights Code', 'Human Tissue Gift Act', 'Hunting and Fishing Heritage Act', 'Hydro and Power Authority Act', 'Hydro Power Measures Act', 'Haida Gwaii Reconciliation Act', 'Hairdressers Act', 'Health Act', 'Health Authorities Act', 'International Interests in Mobile Equipment (Aircraft Equipment) Act', 'International Sale of Goods Act', 'International Trusts Act', 'Interpretation Act', 'Intimate Images Protection Act', 'Islands Trust Act', 'InBC Investment Corp. Act', 'Income Tax Act', 'Income Trust Liability Act', 'Independent School Act', 'Indian Advisory Act', 'Indian Cut-off Lands Disputes Act', 'Indian Self Government Enabling Act', 'Industrial Development Act', 'Industrial Operation Compensation Act', 'Industrial Roads Act', 'Infants Act', 'Information Management Act', 'Innovate BC Act', 'Innovation and Science Council Act', 'Insurance Act', 'Insurance Act', 'Insurance (Captive Company) Act', 'Insurance Corporation Act', 'Insurance for Crops Act', 'Insurance (Motor Vehicle) Act', 'Insurance Premium Tax Act', 'Insurance (Vehicle) Act', 'Integrated Pest Management Act', 'Interjurisdictional Support Orders Act', 'International Business Activity Act', 'International Commercial Arbitration Act', 'International Financial Activity Act', 'Job Protection Act', 'Judicial Compensation Act', 'Judicial Review Procedure Act', 'Jury Act', 'Justice Administration Act', 'Justice Reform and Transparency Act', "King's Counsel Act", 'Knowledge Network Corporation Act', 'Local Government Bylaw Notice Enforcement Act', 'Local Government Grants Act', 'Local Services Act', 'Logging Tax Act', 'Low Carbon Fuels Act', 'Laboratory Services Act', 'Labour Mobility Act', 'Labour Relations Code', 'Land Act', 'Land Owner Transparency Act', 'Land Settlement and Development (Repeal) Act', 'Land (Spouse Protection) Act', 'Land Survey Act', 'Land Surveyors Act', 'Land Tax Deferment Act', 'Land Title Act', 'Land Title and Survey Authority Act', 'Land Title Inquiry Act', 'Land Transfer Form Act', 'Law and Equity Act', 'Law Reform Commission Act', 'Legal Profession Act', 'Legal Services Society Act', 'Legislative Assembly Allowances and Pension Act', 'Legislative Assembly Management Committee Act', 'Legislative Assembly Privilege Act', 'Legislative Library Act', 'Legislative Procedure Review Act', 'Libby Dam Reservoir Act', 'Libel and Slander Act', 'Library Act', 'Limitation Act', 'Liquefied Natural Gas Project Agreements Act', 'Liquor Control and Licensing Act', 'Liquor Distribution Act', 'Livestock Act', 'Livestock Brand Act', 'Livestock Identification Act', 'Livestock Lien Act', 'Lobbyists Registration Act', 'Lobbyists Transparency Act', 'Local Elections Campaign Financing Act', 'Local Elections Statutes Amendment Act, 2014', 'Local Government Act', 'Local Government Act', 'Maa-nulth First Nations Final Agreement Act', 'Manufactured Home Act', 'Manufactured Home Park Tenancy Act', 'Manufactured Home Tax Act', 'Marriage Act', 'McLeod Lake Indian Band Treaty No. 8 Adhesion and Settlement Agreement Act', 'Medical Research (BC Cancer Agency) and Health Status Registry Act', 'Medicare Protection Act', "Members' Conflict of Interest Act", "Members' Remuneration and Pensions Act", 'Mental Health Act', 'Metal Dealers and Recyclers Act', 'Milk Industry Act', 'Mineral Land Tax Act', 'Mineral Tax Act', 'Mineral Tenure Act', 'Mines Act', 'Mining Right of Way Act', 'Ministry of Agriculture and Food Act', 'Ministry of Consumer and Corporate Affairs Act', 'Ministry of Energy and Mines Act', 'Ministry of Energy, Mines and Petroleum Resources Act', 'Ministry of Environment Act', 'Ministry of Forests Act', 'Ministry of Forests and Range Act', 'Ministry of Health Act', 'Ministry of Intergovernmental Relations Act', 'Ministry of International Business and Immigration Act', 'Ministry of Labour Act', 'Ministry of Lands, Parks and Housing Act', 'Ministry of Municipal Affairs Act', 'Ministry of Provincial Secretary and Government Services Act', 'Ministry of Transportation and Highways Act', 'Miscellaneous Registrations Act, 1992', 'Missing Persons Act', 'Mortgage Brokers Act', 'Mortgage Services Act', 'Motion Picture Act', 'Motor Dealer Act', 'Motor Fuel Tax Act', 'Motor Vehicle Act', 'Mountain Resort Associations Act', 'Multiculturalism Act', 'Municipal Act', 'Municipal Aid Act', 'Municipal Finance Authority Act', 'Municipal Replotting Act', 'Municipal Replotting Act', 'Municipalities Enabling and Validating Act', 'Municipalities Enabling and Validating Act (No. 2)', 'Municipalities Enabling and Validating Act (No. 3)', 'Municipalities Enabling and Validating Act (No. 4)', 'Municipalities Enabling and Validating Act (No. 5)', 'Museum Act', 'Music Teachers (Registered) Act', 'Muskwa-Kechika Management Area Act', 'Musqueam Reconciliation, Settlement and Benefits Agreement Implementation Act', 'Mutual Fire Insurance Companies Act', 'Name Act', 'National Day for Truth and Reconciliation Act', 'Natural Gas Price Act', 'Natural Products Marketing (BC) Act', 'Natural Resource Compliance Act', 'Negligence Act', 'New Housing Transition Tax and Rebate Act', 'New Relationship Trust Act', 'New West Partnership Trade Agreement Implementation Act', "Nisga'a Final Agreement Act", 'North Island-Coast Development Initiative Trust Act', 'Northern Development Initiative Trust Act', 'Notaries Act', 'Occupiers Liability Act', 'Offence Act', 'Off-Road Vehicle Act', 'Oil and Gas Activities Act', 'Ombudsman Act', 'Ombudsperson Act', 'Opioid Damages and Health Care Costs Recovery Act', 'Provincial Sales Tax Transitional Provisions and Amendments Act, 2013', 'Provincial Symbols and Honours Act', 'Public Agency Accommodation Act', 'Public Education Labour Relations Act', 'Public Guardian and Trustee Act', 'Public Health Act', 'Public Inquiry Act', 'Public Interest Disclosure Act', 'Public Sector Employers Act', 'Public Sector Pension Plans Act', 'Public Service Act', 'Public Service Benefit Plan Act', 'Public Service Labour Relations Act', 'Public Works Agreement Act', 'Patient Care Quality Review Board Act', 'Patients Property Act', 'Pension Agreement Act', 'Pension Benefits Standards Act', 'Pension Fund Societies Act', 'Perpetuity Act', 'Personal Information Protection Act', 'Personal Property Security Act', 'Petroleum and Natural Gas Act', 'Petroleum and Natural Gas (Vancouver Island Railway Lands) Act', 'Pharmaceutical Services Act', 'Pharmacists, Pharmacy Operations and Drug Scheduling Act', 'Pharmacy Operations and Drug Scheduling Act', 'Pill Press and Related Equipment Control Act', 'Plant Protection Act', 'Police Act', 'Pooled Registered Pension Plans Act', 'Ports Property Tax Act', 'Poverty Reduction Strategy Act', 'Power for Jobs Development Act', 'Power of Appointment Act', 'Power of Attorney Act', 'Presumption of Death Act', 'Prevention of Cruelty to Animals Act', 'Prisons and Reformatories Act (Canada)', 'Privacy Act', 'Private Managed Forest Land Act', 'Private Training Act', 'Probate Fee Act', 'Procurement Services Act', 'Professional Governance Act', 'Profits of Criminal Notoriety Act', 'Property Law Act', 'Property Transfer Tax Act', 'Protected Areas Forests Compensation Act', 'Protected Areas of British Columbia Act', 'Protection of Public Participation Act', 'Provincial Capital Commission Dissolution Act', 'Provincial Court Act', 'Provincial Immigration Programs Act', 'Provincial Sales Tax Act', 'Parental Liability Act', 'Parental Responsibility Act', 'Park Act', 'Partition of Property Act', 'Partnership Act', 'Passenger Transportation Act', "Queen's Counsel Act", "Queen's Printer Act", 'Railway Act', 'Railway Safety Act', 'Range Act', 'Real Estate Development Marketing Act', 'Real Estate Services Act', 'Recall and Initiative Act', 'Recreational Facility Act', 'Red Tape Reduction Day Act', 'Referendum Act', 'Regulations Act', 'Regulatory Reporting Act', 'Rent Distress Act', 'Repairers Lien Act', 'Representation Agreement Act', 'Representative for Children and Youth Act', 'Residential Tenancy Act', 'Resort Associations Act', 'Resort Municipality of Whistler Act', 'Resort Timber Administration Act', 'Riparian Areas Protection Act', 'Royal Roads University Act', 'Safe Streets Act', 'Safety Authority Act', 'Safety Standards Act', 'Sale of Goods Act', 'School Act', 'Science Council Act', 'Sechelt Indian Government District Enabling Act', 'Sechelt Indian Government District Home Owner Grant Act', 'Secure Care Act', 'Securities Act', 'Securities Act', 'Securities (Forged Transfer) Act', 'Securities Transfer Act', 'Security Services Act', 'Seed Potato Act', 'Senior Citizen Automobile Insurance Grant Act', 'Seniors Advocate Act', 'Settlement of International Investment Disputes Act', 'Sex Offender Registry Act', 'Sexual Violence and Misconduct Policy Act', 'Sheriff Act', 'Significant Projects Streamlining Act', 'Skagit Environmental Enhancement Act', 'Skilled Trades BC Act', 'Small Business Venture Capital Act', 'Small Claims Act', 'Social Workers Act', 'Societies Act', 'South Coast British Columbia Transportation Authority Act', 'South Coast British Columbia Transportation Authority Amendment Act, 2012', 'South Coast British Columbia Transportation Authority Funding Referenda Act', 'Southern Interior Development Initiative Trust Act', 'Special Accounts Appropriation and Control Act', 'Special Wine Store Licence Auction Act', 'Speculation and Vacancy Tax Act', 'Statistics Act', 'Statute Revision Act', 'Strata Property Act', 'Subpoena (Interprovincial) Act', 'Succession Duty Repeal Act', 'Supreme Court Act', 'Survivorship and Presumption of Death Act', 'Sustainable Environment Fund Act', 'Tax and Consumer Rate Freeze Act', 'Taxation (Rural Area) Act', 'Teachers Act', 'Temporary Foreign Worker Protection Act', 'Terry Fox Day Act', 'The Hunting and Fishing Heritage Act', 'Thompson Rivers University Act', 'Ticket Sales Act', "Tla'amin Final Agreement Act", 'Tobacco and Vapour Products Control Act', 'Tobacco Control Act', 'Tobacco Damages and Health Care Costs Recovery Act', 'Tobacco Damages Recovery Act', 'Tobacco Sales Act', 'Tobacco Tax Act', 'Tourism Act', 'Tourist Accommodation (Assessment Relief) Act', 'Trade, Investment and Labour Mobility Agreement Implementation Act', 'Transport of Dangerous Goods Act', 'Transportation Act', 'Transportation Investment Act', 'Treaty Commission Act', 'Treaty First Nation Taxation Act', 'Trespass Act', 'Trespass Act', 'Trust and Settlement Variation Act', 'Trustee Act', 'Trustee (Church Property) Act', 'Tsawwassen First Nation Final Agreement Act', 'Tugboat Worker Lien Act', 'Tuition Fee Freeze Act', 'Ukrainian Famine and Genocide (Holodomor) Memorial Day Act', 'Unclaimed Property Act', 'University Act', 'University Endowment Land Act', 'University Foundations Act', 'Utilities Commission Act', 'Vancouver Charter', 'Vancouver Island Natural Gas Pipeline Act', 'Veterinarians Act', 'Veterinary Drugs Act', 'Veterinary Drugs Act', 'Victims of Crime Act', 'Vital Statistics Act', 'Voluntary Blood Donations Act', 'Warehouse Lien Act', 'Warehouse Receipt Act', 'Water Act', 'Water Protection Act', 'Water Sustainability Act', "Water Users' Communities Act", 'Water Utility Act', 'Weed Control Act', 'Wildfire Act', 'Wildlife Act', 'Wills, Estates and Succession Act', 'Witness Security Act', 'Wood First Act', 'Woodworker Lien Act', 'Workers Compensation Act', 'Workers Compensation Act', 'Workers Compensation Amendment Act (No. 2), 2002', 'Yale First Nation Final Agreement Act', 'Youth Justice Act', 'Zero-Emission Vehicles Act', 'Zero Net Deforestation Act']))
    return statutes
    

def test_generate_embeddings():
    filename = "test.csv"
    string_list = ["apple", "banana", "orange"]
    generate_embeddings(string_list, filename)
    df = get_df_by_filename(filename)
    strings, relatedness = strings_ranked_by_relatedness("What fruit is sweetest?", df)
    print(strings)
    print(relatedness)


if __name__ == "__main__":
    main()